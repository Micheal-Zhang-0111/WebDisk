<html>

    <head>
        <meta charset="UTF-8">
        <title>我的页面</title>
        <ion-icon name="folder-outline"></ion-icon>

        <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        <!-- 最新版本的 Bootstrap 核心 CSS 文件 href="https://gcore.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css -->
                                                                                                            
        <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
                                                                                                              crossorigin="anonymous">
        <!-- 可选的 Bootstrap 主题文件（一般不用引入） href="https://gcore.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" -->
        <link rel="stylesheet" src="../css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
                                                                                                                    crossorigin="anonymous">

        <!-- 最新的 Bootstrap 核心 JavaScript 文件  src="https://gcore.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" -->
        <script src="../js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
                                                                                            crossorigin="anonymous"></script>

        <script src="/static/js/auth.js"></script>

        <!-- 设置css字体样式 -->
        <style>
            .cell-text {
                font-size: 20px; /* 设置字体大小 */
                color: black;
                /* 其他样式属性 */
            }
        </style>
    </head>


    <!-- <body style="width:100%;height:100%;
        
        background-image: url('/static/img/bg_Xinhai.png');
        background-size: cover;
        opacity:1"> -->
    <body style="width:100%;height:100%;">
        <video src="/static/img/xinhai.mp4" style="width: 100%;height: 100%;object-fit: cover;position: absolute;top: 0;left: 0;z-index: -1;" autoplay="autoplay" loop="loop" muted="muted" opacity:0.5></video>

        <div style="width:100%;height:100%;">
            <div style="font-size:20px;font-weight:bold;display: grid;place-items: center;
                        background-color: rgba(176, 196, 222, 0.644);height:40px;">
                WebDisk个人主页micheal
            </div>
            <table style="height:100%;width:100%;text-align: center;border-width: 2px; border-color: lightslategrey;">
                <tbody>
                    <tr style="margin-bottom: 20px;">
                        <td style="width:15%;height:100%;background-color:rgba(176, 196, 222, 0.644);">
                            <div style="text-align: top;height:20%;margin: 50px 8px 0 0">
                                <img style="width:80px;height:80px;" src="/static/img/shenhe.jpg"></img>
                                <br>
                                <br>
                                
                                用户名
                                <p id="username" style="color: rgb(240, 255, 36);font-size: 20px;"></p>
                                注册时间
                                <p id="regtime" style="color: rgb(240, 255, 36);font-size: 20px;"></p>
                            </div>
                            <div style="height: 80%;"></div>
                        </td>
                        <td style="text-align: top;">
                            <button class="btn btn-success" onclick="toUploadFile()" style="float: right;margin:0 2% 10px 0;">
                                上传文件
                            </button>
                            <div style="height:98%;" style="width:100%;">
                                <table id="filetbl" style="border: 2px solid gray;margin-left:2%;width:96%;border-collapse: collapse;">
                                    <thead style="height:50px;text-align:center;border: 1px solid gray;">
                                        <tr style="height:50px;border:2px solid rgb(133, 133, 133);">
                                            <th style="text-align: center;font-size: 20px;color: black;">文件索引</th>
                                            <th style="text-align: center;font-size: 20px;color: black;">文件名称</th>
                                            <th style="text-align: center;font-size: 20px;color: black;">文件大小</th>
                                            <th style="text-align: center;font-size: 20px;color: black;">上传时间</th>
                                            <th style="text-align: center;font-size: 20px;color: black;">最近更新</th>
                                            <th style="text-align: center;font-size: 20px;color: black;">操作</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>

    <script lang="javascript">
        window.onload = function () {
            var username = document.getElementById('username');
            $.ajax({
                url: "/user/info?" + queryParams(),
                type: "GET",
                error: function (jqXHR, textStatus, errorThrown) {
                    if (textStatus == "error") {
                        alert(textStatus + " : " + errorThrown);
                    } else {
                        alert(textStatus);
                    }
                },
                success: function (body, textStatus, jqXHR) {
                    var resp = JSON.parse(body);
                    document.getElementById("username").innerHTML = resp.data.Username;
                    document.getElementById("regtime").innerHTML = resp.data.SignupAt;
                    updateFileList();
                }
            });
        }

        function updateFileList() {
            $.ajax({
                url: "/file/query?" + queryParams(),
                type: "POST",
                data: {
                    limit: 15
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (textStatus == "error") {
                        alert(textStatus + " : " + errorThrown);
                    } else {
                        alert(textStatus);
                    }
                },
                success: function (body, textStatus, jqXHR) {
                    if (!body) {
                        return;
                    }
                    var data = JSON.parse(body);
                    if (!data || data.length <= 0) {
                        return;
                    }

                    for (var i = 0; i < data.length; i++) {
                        var x = document.getElementById('filetbl').insertRow();
                        var cell = x.insertCell();
                        cell.innerHTML = '<span class="cell-text">' + data[i].FileHash.substr(0, 20)+"..." + '</span>';

                        cell = x.insertCell();
                        cell.innerHTML = '<span class="cell-text">' + data[i].FileName + '</span>';

                        cell = x.insertCell();
                        cell.innerHTML = '<span class="cell-text">' + data[i].FileSize + '</span>';

                        cell = x.insertCell();
                        cell.innerHTML = '<span class="cell-text">' + data[i].UploadAt + '</span>';

                        cell = x.insertCell();
                        cell.innerHTML = '<span class="cell-text">' + data[i].LastUpdated + '</span>';

                        cell = x.insertCell();
                        cell.innerHTML = '<button class="btn btn-success" ' +
                            'style="height:30px;margin:5px 0;"' +
                            'onClick = "downloadFile(\'/file/' +
                            'downloadurl?filename=' + data[i].FileName + '&filehash=' + data[i].FileHash + '&'  + queryParams() + '\')">下载</button>';
                    }
                }
            });
        }

        function toUploadFile() {
            // window.location.href用于获取当前窗口的URL，并将其设置为新的URL。
            window.location.href = '/file/upload?' + queryParams();
        }

        function downloadFile(durl) {
            $.ajax({
                url: durl,
                type: "GET",
                error: function (jqXHR, textStatus, errorThrown) {
                    if (textStatus == "error") {
                        alert(textStatus + " : " + errorThrown);
                    } else {
                        alert(textStatus);
                    }
                },
                success: function (body, textStatus, jqXHR) {
                    try {
                        alert("download from:\n" + body);   //弹窗显示下载地址
                        var elemIF = document.createElement("iframe");//iframe元素是一个内嵌的浏览器窗口，可以用来显示其他网页或下载文件。
                        elemIF.src = body;                              //iframe将加载并显示body变量中指定的URL。
                        elemIF.style.display = "none";                  //这使得iframe元素在页面上不可见，但仍然可以加载和执行。
                        document.body.appendChild(elemIF);  //将elemIF元素添加到document.body中，也就是将其插入到页面的主体部分。这样，iframe元素就会被添加到页面中，并开始加载和显示指定的文件。
                    } catch (e) {
                        alert(e);
                    }
                }
            });
        }
    </script>

</html>
